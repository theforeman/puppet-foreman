#!/usr/bin/env ruby

# Script to disable a given host in Nagios when Foreman
# puts it into build mode.
#
# This prevents a flurry of meaningless monitoring alerts.

require 'net/http'
require 'json'

icinga_url = "http://<%= @foreman_icinga_host %>:<%= @foreman_icinga_port %>"
# http://icinga.sal01.datacentred.co.uk:24554

uri = URI("#{icinga_url}/schedule_downtime")
req = Net::HTTP::Post.new(uri, initheader = {'Content-Type' =>'application/json'})
req.body = {host: ARGV[2], duration: 600}.to_json

res = Net::HTTP.start(uri.hostname, uri.port) do |http|
  http.request(req)
end

res = JSON.parse(req.body)
raise StandardError, res['content'] unless res['success']

