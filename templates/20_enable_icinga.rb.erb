#!/usr/bin/env ruby

# Script to enable a given host in Nagios when Foreman
# finishes building it.

require 'net/http'
require 'json'

icinga_url = "http://<%= @foreman_icinga_host %>:<%= @foreman_icinga_port %>"

# http://icinga.sal01.datacentred.co.uk:24554

uri = URI("#{icinga_url}/cancel_downtime")
req = Net::HTTP::Post.new(uri, initheader = {'Content-Type' =>'application/json'})
req.body = {host: ARGV[2]}.to_json

res = Net::HTTP.start(uri.hostname, uri.port) do |http|
  http.request(req)
end

res = JSON.parse(req.body)
raise StandardError, res['content'] unless res['success']
